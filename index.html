<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Mini GTA 3D Android</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<style>
body{margin:0;overflow:hidden;background:black;touch-action:none}
#joystick{position:absolute;left:20px;bottom:20px;width:120px;height:120px;border-radius:50%;background:rgba(255,255,255,.15)}
#stick{position:absolute;width:50px;height:50px;left:35px;top:35px;border-radius:50%;background:rgba(255,255,255,.6)}
</style>
</head>
<body>

<div id="joystick"><div id="stick"></div></div>

<script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>
<script>
// ================= ESCENA =================
const scene=new THREE.Scene();
scene.background=new THREE.Color(0x87ceeb);

const camera=new THREE.PerspectiveCamera(70,innerWidth/innerHeight,0.1,3000);
const renderer=new THREE.WebGLRenderer({antialias:true});
renderer.setSize(innerWidth,innerHeight);
document.body.appendChild(renderer.domElement);

scene.add(new THREE.AmbientLight(0xffffff,0.7));
const sun=new THREE.DirectionalLight(0xffffff,0.6);
sun.position.set(20,40,20);
scene.add(sun);

// ================= MAPA =================
const MAP = 820;

const ground=new THREE.Mesh(
  new THREE.PlaneGeometry(MAP,MAP),
  new THREE.MeshStandardMaterial({color:0x2e7d32})
);
ground.rotation.x=-Math.PI/2;
scene.add(ground);

// ================= CALLES =================
const ROAD_SPACING=80;
const ROAD_WIDTH=8;
const ROAD_MARGIN=6;
const roadMat=new THREE.MeshStandardMaterial({color:0x555555});

for(let i=-320;i<=320;i+=ROAD_SPACING){
  const r1=new THREE.Mesh(new THREE.PlaneGeometry(MAP,ROAD_WIDTH),roadMat);
  r1.rotation.x=-Math.PI/2;
  r1.position.z=i;
  r1.position.y=0.01;
  scene.add(r1);

  const r2=new THREE.Mesh(new THREE.PlaneGeometry(ROAD_WIDTH,MAP),roadMat);
  r2.rotation.x=-Math.PI/2;
  r2.position.x=i;
  r2.position.y=0.01;
  scene.add(r2);
}

function isOnRoad(x,z,half){
  for(let i=-320;i<=320;i+=ROAD_SPACING){
    if(Math.abs(z-i)<ROAD_WIDTH/2+ROAD_MARGIN+half) return true;
    if(Math.abs(x-i)<ROAD_WIDTH/2+ROAD_MARGIN+half) return true;
  }
  return false;
}

// ================= EDIFICIOS + VENTANAS =================
const buildingColors=[0xd6d3cc,0xb0b0b0,0xc2b280,0xa1866f,0x8d6e63,0xf5f5f5,0x9e9e9e];
const windowMat=new THREE.MeshStandardMaterial({color:0x222244,emissive:0x111133});

for(let i=0;i<120;i++){
  let x,z,w;
  do{
    x=Math.random()*700-350;
    z=Math.random()*700-350;
    w=14+Math.random()*10;
  }while(isOnRoad(x,z,w/2));

  const h=10+Math.random()*35;

  const b=new THREE.Group();

  const base=new THREE.Mesh(
    new THREE.BoxGeometry(w,h,w),
    new THREE.MeshStandardMaterial({color:buildingColors[Math.random()*buildingColors.length|0]})
  );
  base.position.y=h/2;
  b.add(base);

  // ventanas falsas
  for(let y=3;y<h-2;y+=3){
    for(let xw=-w/2+2;xw<w/2-2;xw+=3){
      const win=new THREE.Mesh(new THREE.BoxGeometry(1.2,1.2,0.2),windowMat);
      win.position.set(xw,y,w/2+0.11);
      b.add(win);

      const win2=win.clone();
      win2.position.z=-w/2-0.11;
      b.add(win2);
    }
  }

  b.position.set(x,0,z);
  scene.add(b);
}

// ================= HUMANOS =================
function human(color){
  const g=new THREE.Group();
  const m=new THREE.MeshStandardMaterial({color});

  const body=new THREE.Mesh(new THREE.BoxGeometry(0.8,1.2,0.4),m);
  body.position.y=1.6;
  const head=new THREE.Mesh(new THREE.BoxGeometry(0.5,0.5,0.5),m);
  head.position.y=2.4;

  const face=new THREE.MeshBasicMaterial({color:0x000});
  const e1=new THREE.Mesh(new THREE.SphereGeometry(0.05),face);
  const e2=e1.clone();
  e1.position.set(-0.1,0.05,0.26);
  e2.position.set(0.1,0.05,0.26);
  const smile=new THREE.Mesh(new THREE.TorusGeometry(0.12,0.02,6,12,Math.PI),face);
  smile.rotation.x=Math.PI/2;
  smile.position.set(0,-0.12,0.25);
  head.add(e1,e2,smile);

  const aL=new THREE.Mesh(new THREE.BoxGeometry(0.25,0.9,0.25),m);
  const aR=aL.clone();
  aL.position.set(-0.6,1.6,0);
  aR.position.set(0.6,1.6,0);
  const lL=new THREE.Mesh(new THREE.BoxGeometry(0.3,1,0.3),m);
  const lR=lL.clone();
  lL.position.set(-0.2,0.6,0);
  lR.position.set(0.2,0.6,0);

  g.add(body,head,aL,aR,lL,lR);
  g.arms=[aL,aR]; g.legs=[lL,lR];
  return g;
}

// ================= PLAYER =================
const player={mesh:human(0x00ffff),speed:1.3};
scene.add(player.mesh);

// ================= PEATONES =================
const npcs=[];
for(let i=0;i<30;i++){
  let x,z;
  do{
    x=Math.random()*700-350;
    z=Math.random()*700-350;
  }while(isOnRoad(x,z,2));

  const n=human(0xffa0b4);
  n.position.set(x,0,z);
  scene.add(n);
  npcs.push({mesh:n,dir:Math.random()*Math.PI*2,speed:1.3,timer:0});
}

// ================= JOYSTICK =================
const joy={x:0,y:0,active:false};
const stick=document.getElementById("stick");
joystick.ontouchstart=()=>joy.active=true;
joystick.ontouchmove=e=>{
  const t=e.touches[0],r=joystick.getBoundingClientRect();
  joy.x=t.clientX-r.left-60;
  joy.y=t.clientY-r.top-60;
  const d=Math.hypot(joy.x,joy.y);
  if(d>40){joy.x*=40/d;joy.y*=40/d;}
  stick.style.left=35+joy.x+"px";
  stick.style.top=35+joy.y+"px";
};
joystick.ontouchend=()=>{joy.active=false;joy.x=joy.y=0;stick.style.left="35px";stick.style.top="35px";};

// ================= CÃMARA 360 =================
let camAngle=0,lastX=null;
renderer.domElement.addEventListener("touchstart",e=>lastX=e.touches[0].clientX);
renderer.domElement.addEventListener("touchmove",e=>{
  camAngle-=(e.touches[0].clientX-lastX)*0.005;
  lastX=e.touches[0].clientX;
});
renderer.domElement.addEventListener("touchend",()=>lastX=null);

// ================= LOOP =================
function loop(){
  requestAnimationFrame(loop);

  if(joy.active){
    const f=joy.y*player.speed*0.01;
    const s=joy.x*player.speed*0.01;
    const mx=Math.sin(camAngle)*f+Math.sin(camAngle+Math.PI/2)*s;
    const mz=Math.cos(camAngle)*f+Math.cos(camAngle+Math.PI/2)*s;
    player.mesh.position.x+=mx;
    player.mesh.position.z+=mz;
    player.mesh.rotation.y+=(Math.atan2(mx,mz)-player.mesh.rotation.y)*0.2;
  }

  npcs.forEach(n=>{
    n.timer--;
    if(n.timer<=0){n.dir=Math.random()*Math.PI*2;n.timer=120;}
    const mx=Math.sin(n.dir)*n.speed*0.02;
    const mz=Math.cos(n.dir)*n.speed*0.02;
    n.mesh.position.x+=mx;
    n.mesh.position.z+=mz;
    n.mesh.rotation.y+=(Math.atan2(mx,mz)-n.mesh.rotation.y)*0.1;
  });

  camera.position.set(
    player.mesh.position.x+Math.sin(camAngle)*12,
    7,
    player.mesh.position.z+Math.cos(camAngle)*12
  );
  camera.lookAt(player.mesh.position.clone().add(new THREE.Vector3(0,2,0)));

  renderer.render(scene,camera);
}
loop();
</script>
</body>
</html>
